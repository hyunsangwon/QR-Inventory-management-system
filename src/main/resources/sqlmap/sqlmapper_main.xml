<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="pro.cntech.inventory.mapper.MainMapper">

    <select id="getUserInfo" resultType="pro.cntech.inventory.vo.UserVO">
        SELECT
            m_number AS phone,
            password,
            user_srl AS userSrl,
            user_name AS userName,
            addr,
            detail_addr AS detailAddr,
            auth,
            company_name AS companyName,
            s_number AS companyPhone
        FROM users
        WHERE m_number = #{phone}
    </select>

    <select id="getMainStatistics" resultType="pro.cntech.inventory.vo.StatisticsVO">
        SELECT
            COUNT(o.obj_srl) AS totalCnt,
            (
            SELECT
                COUNT(o.obj_srl)
            FROM obj AS o
            INNER JOIN users AS u
            ON o.user_srl = u.user_srl
            WHERE u.master_srl = #{userSrl}
            AND o.obj_status IN ('outer_wait','release_finish','return_start')
            )
        AS outerCount,
        (
            SELECT
                COUNT(o.obj_srl)
            FROM obj AS o
            INNER JOIN users AS u
            ON o.user_srl = u.user_srl
            WHERE u.master_srl = #{userSrl}
            AND o.obj_status IN ('inner_wait','return_wait','return_finish','release_start')
        )
        AS innerCount
        FROM obj AS o
        INNER JOIN users AS u
        ON o.user_srl = u.user_srl
        WHERE u.master_srl = #{userSrl}
    </select>

    <select id="getCompanyGPS" parameterType="pro.cntech.inventory.vo.UserVO" resultType="pro.cntech.inventory.vo.MarkerVO">
        SELECT
            o.obj_srl AS objSrl,
            c.company_srl AS companySrl,
            c.company_name AS companyName,
            c.addr AS companyAddr,
            c.phone AS companyPhone,
            o.latitude,
            o.longitude,
            o.obj_status AS objStatus
        FROM obj AS o
        INNER JOIN company AS c
        ON o.company_srl = c.company_srl
        INNER JOIN users AS u
        ON c.user_srl = u.user_srl
        WHERE u.master_srl = #{userSrl}
      <!-- GROUP BY o.company_srl-->
    </select>

    <update id="updateMyInfo" parameterType="pro.cntech.inventory.vo.UserVO">
        UPDATE users
        SET
            user_name = #{userName}
            <if test='password neq ""'>
            ,password = #{password}
            </if>
            ,addr = #{addr}
            ,m_number = #{phone}
            ,s_number = #{companyPhone}
            ,company_name = #{companyName}
        WHERE user_srl = #{userSrl}
    </update>

</mapper>